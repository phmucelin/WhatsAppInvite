<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéâ Convite Personalizado</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: -1;
        }
        
        .invite-container {
            max-width: 600px;
            margin: 20px auto;
            background: linear-gradient(145deg, #0f2027, #203a43, #2c5364);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            position: relative;
        }
        
        .invite-header {
            background: linear-gradient(135deg, #0f2027, #203a43);
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .invite-header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 600;
            background: linear-gradient(45deg, #fff, #87ceeb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }
        
        .guest-name {
            background: linear-gradient(135deg, #0f2027, #203a43);
            padding: 25px;
            text-align: center;
            border-radius: 0;
            margin: 0;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .guest-name h2 {
            margin: 0;
            font-size: 2em;
            font-weight: 500;
            color: #87ceeb;
            text-shadow: 0 2px 10px rgba(135, 206, 235, 0.3);
            letter-spacing: -0.01em;
        }
        
        .invite-image {
            background: linear-gradient(135deg, #0f2027, #203a43);
            padding: 30px;
            text-align: center;
            border-radius: 0;
        }
        
        .invite-image img {
            max-width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }
        
        .invite-image img:hover {
            transform: scale(1.02);
        }
        
        .invite-content {
            background: linear-gradient(135deg, #0f2027, #203a43);
            padding: 30px;
        }
        
        .info-item {
            background: linear-gradient(135deg, #0f2027, #203a43);
            margin: 20px 0;
            padding: 20px;
            border-left: 4px solid #87ceeb;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.3);
        }
        
        .info-item h3 {
            margin: 0 0 10px 0;
            color: #87ceeb;
            font-size: 1.3em;
            font-weight: 500;
            letter-spacing: -0.01em;
        }
        
        .info-item p {
            margin: 0;
            color: white;
            font-size: 1.1em;
            line-height: 1.6;
            font-weight: 400;
        }
        
        .confirmation-buttons {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            display: inline-block;
            padding: 15px 40px;
            margin: 0 8px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Inter', sans-serif;
        }
        
        .btn-confirm {
            background: linear-gradient(135deg, #0c4a6e 0%, #075985 50%, #0369a1 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.4);
        }
        
        .btn-confirm:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(14, 165, 233, 0.6);
        }
        
        .btn-decline {
            background: linear-gradient(135deg, #7c2d12 0%, #9a3412 50%, #c2410c 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
        }
        
        .btn-decline:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(220, 38, 38, 0.6);
        }
        
        .placeholder {
            text-align: center;
            padding: 40px;
            color: #87ceeb;
        }
        
        .placeholder i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.7;
        }
        
        .placeholder p {
            font-size: 1.2em;
            margin: 0;
            opacity: 0.8;
            font-weight: 400;
        }
        
        .loading {
            text-align: center;
            padding: 60px 30px;
            color: #87ceeb;
        }
        
        .loading i {
            font-size: 3em;
            margin-bottom: 20px;
            animation: spin 1s linear infinite;
        }
        
        .loading p {
            font-size: 1.2em;
            margin: 0;
            opacity: 0.8;
            font-weight: 400;
        }
        
        .error {
            text-align: center;
            padding: 40px 30px;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border-radius: 15px;
            margin: 20px;
        }
        
        .error i {
            font-size: 3em;
            margin-bottom: 20px;
            color: #fecaca;
        }
        
        .error p {
            font-size: 1.1em;
            margin: 0;
            opacity: 0.9;
            font-weight: 400;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes spectacularEntry {
            0% { 
                opacity: 0; 
                transform: translateY(100px) scale(0.3); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        @keyframes iconBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes textSlideIn {
            0% { 
                opacity: 0; 
                transform: translateX(-30px); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        @keyframes buttonAppear {
            0% { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .invite-container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .invite-header h1 {
                font-size: 2em;
            }
            
            .guest-name h2 {
                font-size: 1.6em;
            }
            
            .btn {
                display: block;
                margin: 15px auto;
                width: 80%;
            }
            
            .confirmation-buttons {
                margin: 20px 0;
            }
        }
    </style>
</head>
<body>
    <div class="invite-container">
        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Carregando convite...</p>
        </div>

        <div id="inviteContent" style="display: none;">
            <div class="guest-name" id="guestName">
                Ol√°, Convidado!
            </div>

            <div class="invite-header">
                <h1 id="eventName">Nome do Evento</h1>
                <div class="event-date" id="eventDate">Data do evento</div>
            </div>

            <div class="invite-image" id="inviteImage">
                <div class="placeholder">
                    <i class="fas fa-image"></i>
                </div>
            </div>

            <div class="invite-content">
                <div class="info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <div class="info-text">
                        <h3>Data e Hora</h3>
                        <p id="eventDateTime">Data e hora do evento</p>
                    </div>
                </div>

                <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <div class="info-text">
                        <h3>Local</h3>
                        <p id="eventLocation">Local do evento</p>
                    </div>
                </div>

                <div class="info-item">
                    <i class="fas fa-info-circle"></i>
                    <div class="info-text">
                        <h3>Descri√ß√£o</h3>
                        <p id="eventDescription">Descri√ß√£o do evento</p>
                    </div>
                </div>

                <div class="confirmation-buttons">
                    <button class="btn btn-confirm" onclick="confirmPresence('confirmed')">
                        <i class="fas fa-check"></i> Confirmar Presen√ßa
                    </button>
                    <button class="btn btn-decline" onclick="confirmPresence('declined')">
                        <i class="fas fa-times"></i> N√£o Posso Ir
                    </button>
                </div>
            </div>
        </div>

        <div id="errorMessage" class="error" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Erro ao carregar o convite. Verifique se o link est√° correto.</p>
        </div>
    </div>

    <script>
        // Fun√ß√£o para carregar dados do convite
        async function loadInviteData() {
            try {
                console.log('üîç Iniciando carregamento do convite...');

                // Pegar par√¢metros da URL (compatibilidade com par√¢metros novos e antigos)
                const urlParams = new URLSearchParams(window.location.search);
                const eventId = urlParams.get('e') || urlParams.get('event');
                const guestId = urlParams.get('g') || urlParams.get('guest');
                const timestamp = urlParams.get('t');

                console.log('üì± Par√¢metros da URL:', { eventId, guestId, timestamp });

                if (!eventId || !guestId) {
                    throw new Error(`Par√¢metros inv√°lidos: e=${eventId}, g=${guestId}`);
                }

                // Dados da URL - usando par√¢metros otimizados
                const eventName = urlParams.get('n') || urlParams.get('eventName');
                const eventDate = urlParams.get('d') || urlParams.get('eventDate');
                const eventLocation = urlParams.get('l') || urlParams.get('eventLocation');
                const eventDescription = urlParams.get('desc') || urlParams.get('eventDescription');
                const nameFromUrl = urlParams.get('nm') || urlParams.get('name');

                // SOLU√á√ÉO ULTRA-OTIMIZADA: Carregar imagem do localStorage usando hash
                const imageHash = urlParams.get('ih') || urlParams.get('img') || urlParams.get('image');
                
                console.log('üìä Dados da URL:', { eventName, eventDate, eventLocation, eventDescription, nameFromUrl, hasImage: !!imageHash });
                console.log('üîç Par√¢metros completos da URL:', Object.fromEntries(urlParams.entries()));
                
                // Criar objeto de dados do evento
                const eventData = {
                    name: eventName || 'Nome do Evento',
                    date: eventDate || new Date().toISOString(),
                    location: eventLocation || 'Local do evento',
                    description: eventDescription || 'Descri√ß√£o do evento'
                };
                
                // Criar objeto do convidado
                const guest = {
                    id: guestId,
                    nome: nameFromUrl ? decodeURIComponent(nameFromUrl) : 'Convidado',
                    numero: '+5511999999999',
                    status: 'pending'
                };
                
                console.log('üìä Dados finais:', { eventData, guest });
                
                // Preencher dados na p√°gina
                console.log('üìù Preenchendo dados na p√°gina...');
                
                try {
                    document.getElementById('guestName').textContent = `Ol√°, ${guest.nome}!`;
                    document.getElementById('eventName').textContent = eventData.name;
                    document.getElementById('eventDate').textContent = formatDate(eventData.date);
                    document.getElementById('eventDateTime').textContent = formatDateTime(eventData.date);
                    document.getElementById('eventLocation').textContent = eventData.location;
                    document.getElementById('eventDescription').textContent = eventData.description;
                    
                    console.log('‚úÖ Dados preenchidos com sucesso');
                } catch (error) {
                    console.error('‚ùå Erro ao preencher dados:', error);
                    throw new Error('Erro ao preencher dados na p√°gina: ' + error.message);
                }
                
                // Carregar imagem se existir (do localStorage ou URL)
                console.log('üñºÔ∏è Verificando imagem...');
                
                if (imageHash) {
                    console.log('üñºÔ∏è Hash da imagem encontrado:', imageHash);
                    const imageContainer = document.getElementById('inviteImage');
                    
                    // Tentar carregar do localStorage primeiro (solu√ß√£o otimizada)
                    let imageSrc = null;
                    
                    if (urlParams.get('ih')) {
                        console.log('üîç Tentando carregar do localStorage com hash:', imageHash);
                        // Nova solu√ß√£o: carregar do localStorage
                        imageSrc = localStorage.getItem(`img_${imageHash}`);
                        if (imageSrc) {
                            console.log('‚úÖ Imagem carregada do localStorage');
                        } else {
                            console.log('‚ùå Imagem n√£o encontrada no localStorage');
                        }
                    }
                    
                    // Fallback: tentar carregar da URL (compatibilidade)
                    if (!imageSrc && (urlParams.get('img') || urlParams.get('image'))) {
                        console.log('üîç Tentando carregar da URL (fallback)');
                        imageSrc = decodeURIComponent(urlParams.get('img') || urlParams.get('image'));
                        console.log('‚úÖ Imagem carregada da URL (fallback)');
                    }
                    
                    if (imageSrc) {
                        console.log('üñºÔ∏è Carregando imagem na p√°gina...');
                        const img = document.createElement('img');
                        img.src = imageSrc;
                        img.alt = 'Convite';
                        img.style.cssText = `
                            max-width: 100%;
                            height: auto;
                            border-radius: 10px;
                            display: block;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                        `;
                        
                        img.onerror = function() {
                            console.error('‚ùå Erro ao carregar imagem');
                            imageContainer.innerHTML = '<div class="placeholder"><i class="fas fa-image"></i><p>Erro ao carregar imagem</p></div>';
                        };
                        
                        img.onload = function() {
                            console.log('‚úÖ Imagem carregada com sucesso!');
                        };
                        
                        imageContainer.innerHTML = '';
                        imageContainer.appendChild(img);
                    } else {
                        console.log('‚ùå Imagem n√£o encontrada em nenhuma fonte');
                        imageContainer.innerHTML = '<div class="placeholder"><i class="fas fa-image"></i><p>Imagem n√£o encontrada</p></div>';
                    }
                } else {
                    console.log('‚ÑπÔ∏è Nenhuma imagem na URL');
                    const imageContainer = document.getElementById('inviteImage');
                    imageContainer.innerHTML = '<div class="placeholder"><i class="fas fa-image"></i><p>Nenhuma imagem selecionada</p></div>';
                }

                // Salvar dados para confirma√ß√£o
                window.inviteData = {
                    eventId: eventId,
                    guestId: guestId,
                    guest: guest,
                    eventData: eventData
                };

                console.log('‚úÖ Todos os dados foram carregados com sucesso!');
                console.log('üìä Dados finais:', window.inviteData);

                // Mostrar conte√∫do e esconder loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('inviteContent').style.display = 'block';
                
                console.log('üéâ Convite carregado e exibido com sucesso!');

            } catch (error) {
                console.error('Erro ao carregar convite:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
            }
        }

        // Fun√ß√£o para carregar imagem no container (MOVIDA PARA FORA)
        function loadImageToContainer(imageSrc) {
            const imageContainer = document.getElementById('inviteImage');
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.alt = 'Convite';
            img.style.cssText = `
                max-width: 100%;
                height: auto;
                border-radius: 10px;
                display: block;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            `;
            
            img.onerror = function() {
                console.error('‚ùå Erro ao carregar imagem:', imageSrc);
                imageContainer.innerHTML = '<div class="placeholder"><i class="fas fa-image"></i><p>Erro ao carregar imagem</p></div>';
            };
            
            img.onload = function() {
                console.log('‚úÖ Imagem carregada com sucesso!');
            };
            
            imageContainer.innerHTML = '';
            imageContainer.appendChild(img);
        }

        // Fun√ß√£o para confirmar presen√ßa
        function confirmPresence(status) {
            try {
                const guestId = new URLSearchParams(window.location.search).get('guest');
                
                // Carregar lista de convidados do localStorage
                const savedGuests = localStorage.getItem('guests');
                if (savedGuests) {
                    const guests = JSON.parse(savedGuests);
                    const guestIndex = guests.findIndex(g => g.id === guestId);
                    
                    if (guestIndex !== -1) {
                        // Atualizar status do convidado
                        guests[guestIndex].status = status;
                        localStorage.setItem('guests', JSON.stringify(guests));
                        
                        // Salvar timestamp da √∫ltima atualiza√ß√£o
                        localStorage.setItem('lastConfirmationUpdate', Date.now().toString());
                        
                        console.log('‚úÖ Status atualizado:', guests[guestIndex].nome, '->', status);
                    }
                }
                
                // Tentar notificar a aplica√ß√£o principal
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'confirmation_update',
                        guestId: guestId,
                        status: status
                    }, '*');
                    console.log('üì§ Mensagem enviada para aplica√ß√£o principal');
                }
                
                // Mostrar mensagem de confirma√ß√£o
                showConfirmationMessage(status);
                
            } catch (error) {
                console.error('Erro ao confirmar presen√ßa:', error);
                alert('Erro ao confirmar presen√ßa. Tente novamente.');
            }
        }
        
        // Fun√ß√£o para mostrar mensagem de confirma√ß√£o
        function showConfirmationMessage(status) {
            const mainContent = document.querySelector('.invite-container');
            const statusText = status === 'confirmed' ? 'Presen√ßa Confirmada!' : 'Presen√ßa Declinada';
            const statusIcon = status === 'confirmed' ? '‚úÖ' : '‚ùå';
            const statusColor = status === 'confirmed' ? '#4CAF50' : '#f44336';
            
            mainContent.innerHTML = `
                <div style="
                    text-align: center;
                    padding: 60px 30px;
                    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                    border-radius: 20px;
                    color: white;
                    animation: spectacularEntry 0.8s ease-out;
                ">
                    <div style="
                        font-size: 4em;
                        margin-bottom: 20px;
                        animation: iconBounce 1s ease-out 0.3s both;
                    ">
                        ${statusIcon}
                    </div>
                    <h1 style="
                        font-size: 2.5em;
                        margin-bottom: 20px;
                        color: ${statusColor};
                        animation: textSlideIn 0.8s ease-out 0.5s both;
                    ">
                        ${statusText}
                    </h1>
                    <p style="
                        font-size: 1.2em;
                        margin-bottom: 30px;
                        opacity: 0.9;
                        animation: textSlideIn 0.8s ease-out 0.7s both;
                    ">
                        Obrigado por confirmar sua presen√ßa!
                    </p>
                    <button onclick="window.close()" style="
                        background: linear-gradient(135deg, #667eea, #764ba2);
                        color: white;
                        border: none;
                        padding: 15px 40px;
                        border-radius: 50px;
                        font-size: 1.1em;
                        cursor: pointer;
                        animation: buttonAppear 0.8s ease-out 0.9s both;
                    ">
                        Fechar
                    </button>
                </div>
            `;
        }

        // Fun√ß√µes utilit√°rias
        function formatDate(dateString) {
            if (!dateString) return 'Data n√£o definida';
            
            try {
                // Verificar se √© formato DD/MM (novo formato otimizado)
                if (dateString.includes('/') && dateString.split('/').length === 2) {
                    const [day, month] = dateString.split('/');
                    const currentYear = new Date().getFullYear();
                    const date = new Date(currentYear, parseInt(month) - 1, parseInt(day));
                    
                    if (isNaN(date.getTime())) {
                        console.warn('‚ö†Ô∏è Data inv√°lida (formato DD/MM):', dateString);
                        return 'Data inv√°lida';
                    }
                    
                    return date.toLocaleDateString('pt-BR', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
                
                // Formato ISO padr√£o
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    console.warn('‚ö†Ô∏è Data inv√°lida:', dateString);
                    return 'Data inv√°lida';
                }
                
                return date.toLocaleDateString('pt-BR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                console.error('‚ùå Erro ao formatar data:', error);
                return 'Data inv√°lida';
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Data e hora n√£o definidas';
            
            try {
                // Verificar se √© formato DD/MM (novo formato otimizado)
                if (dateString.includes('/') && dateString.split('/').length === 2) {
                    const [day, month] = dateString.split('/');
                    const currentYear = new Date().getFullYear();
                    const date = new Date(currentYear, parseInt(month) - 1, parseInt(day));
                    
                    if (isNaN(date.getTime())) {
                        console.warn('‚ö†Ô∏è Data inv√°lida (formato DD/MM):', dateString);
                        return 'Data e hora inv√°lidas';
                    }
                    
                    return date.toLocaleString('pt-BR', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                
                // Formato ISO padr√£o
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    console.warn('‚ö†Ô∏è Data inv√°lida:', dateString);
                    return 'Data e hora inv√°lidas';
                }
                
                return date.toLocaleString('pt-BR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                console.error('‚ùå Erro ao formatar data e hora:', error);
                return 'Data e hora inv√°lidas';
            }
        }

        // Carregar dados quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ P√°gina carregada, iniciando carregamento do convite...');
            
            // Debug: mostrar todos os par√¢metros da URL
            const urlParams = new URLSearchParams(window.location.search);
            console.log('üîç Todos os par√¢metros da URL:', Object.fromEntries(urlParams.entries()));
            
            // Verificar se h√° par√¢metros m√≠nimos
            const hasMinParams = urlParams.get('e') || urlParams.get('event');
            const hasGuest = urlParams.get('g') || urlParams.get('guest');
            
            console.log('üìã Par√¢metros m√≠nimos:', { hasMinParams, hasGuest });
            
            if (!hasMinParams || !hasGuest) {
                console.error('‚ùå Par√¢metros m√≠nimos n√£o encontrados');
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                return;
            }
            
            loadInviteData();
        });
    </script>
</body>
</html>